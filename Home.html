<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CableDrop</title>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 600px; margin: 0 auto; padding: 40px; text-align: center; }
      .card { background: #f4f4f4; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
      button { background: #007bff; color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 6px; cursor: pointer; margin: 10px; }
      button:disabled { background: #ccc; cursor: not-allowed; }
      button.secondary { background: #6c757d; }
      button.secondary:hover { background: #5a6268; }
      .hidden { display: none; }
      #log { margin-top: 20px; text-align: left; max-height: 200px; overflow-y: auto; background: #eee; padding: 10px; font-family: monospace; font-size: 12px; }
      .folder-options { margin: 15px 0; }
      .folder-button { display: block; margin: 8px auto; width: 90%; text-align: left; padding: 12px; background: #e9ecef; color: #000; border: 1px solid #dee2e6; cursor: pointer; border-radius: 6px; }
      .folder-button:hover { background: #dee2e6; }
      .divider { margin: 15px 0; text-align: center; color: #999; }
      .progress-wrap { margin-top: 15px; }
      progress { width: 100%; height: 16px; }
      #progressText { font-size: 0.9em; color: #555; margin-top: 6px; }
    </style>
  </head>
  <body>
    <header></header>
    <main>
      <div class="card">
        <h1>ðŸ“² Photo Router</h1>
        <p>Transfer photos from iPhone to PC entirely offline.</p>

        <div id="step1">
          <h3>Step 1: Select Photos from iPhone</h3>
          <p style="font-size: 0.9em; color: #666;">(Navigate to This PC > Apple iPhone > Internal Storage > DCIM)</p>
          <input type="file" id="sourceInput" multiple accept="image/*,.heic,.MOV" class="hidden">
          <button onclick="document.getElementById('sourceInput').click()">ðŸ“¸ Select Photos from iPhone</button>
        </div>

        <div id="step2" class="hidden">
          <h3>Step 2: Where should photos go?</h3>
          <p style="font-size: 0.9em; color: #666;">Select destination folder for backup</p>

          <div class="folder-options" id="commonFolders"></div>

          <div class="divider">or</div>

          <div>
            <button onclick="downloadToCustom()" class="secondary">ðŸ’¾ Save to Custom Location</button>
          </div>
        </div>

        <div id="progressWrap" class="progress-wrap hidden">
          <progress id="progressBar" value="0" max="100"></progress>
          <div id="progressText">Preparingâ€¦</div>
        </div>

        <div id="log" class="hidden"></div>
      </div>
    </main>
    <footer></footer>

    <script>
      let destinationPath = null;
      let selectedFilesArray = [];

      const progressWrap = document.getElementById('progressWrap');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');

      function showProgress() {
        progressWrap.classList.remove('hidden');
      }

      function hideProgress() {
        progressWrap.classList.add('hidden');
        progressBar.value = 0;
        progressText.textContent = 'Preparingâ€¦';
      }

      function setProgress(percent, label) {
        progressBar.value = Math.max(0, Math.min(100, percent));
        if (label) progressText.textContent = label;
      }

      // 1. Select photos from phone first
      document.getElementById("sourceInput").addEventListener("change", (event) => {
        const files = event.target.files;
        if (files.length === 0) return;

        selectedFilesArray = Array.from(files);

        const logDiv = document.getElementById("log");
        logDiv.classList.remove("hidden");
        log(`âœ… Selected ${selectedFilesArray.length} photos from iPhone`);
        selectedFilesArray.forEach((file, idx) => {
          log(`   ${idx + 1}. ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
        });

        document.getElementById("step1").classList.add("hidden");
        document.getElementById("step2").classList.remove("hidden");
        loadCommonFolders();
      });

      async function loadCommonFolders() {
        try {
          const response = await fetch('/api/get-common-folders');
          const data = await response.json();

          const container = document.getElementById('commonFolders');
          container.innerHTML = '<p style="font-size: 0.9em; color: #666;">Quick select:</p>';

          if (data.folders && data.folders.length > 0) {
            data.folders.forEach(folder => {
              const btn = document.createElement('button');
              btn.className = 'folder-button';
              btn.textContent = `ðŸ“ ${folder.name}`;
              btn.onclick = () => selectPath(folder.path);
              container.appendChild(btn);
            });
          }
        } catch (err) {
          console.error('Error loading folders:', err);
        }
      }

      async function selectPath(path) {
        await setDestinationPath(path);
      }

      async function downloadToCustom() {
        if (!selectedFilesArray || selectedFilesArray.length === 0) {
          alert('No photos selected!');
          return;
        }

        log(`ðŸ’¾ Preparing ZIP for ${selectedFilesArray.length} files...`);
        showProgress();
        setProgress(0, 'Uploading photosâ€¦');

        try {
          const formData = new FormData();
          for (let i = 0; i < selectedFilesArray.length; i++) {
            formData.append('files', selectedFilesArray[i]);
          }

          const blob = await uploadWithProgress('/api/download-zip', formData, 'Uploading photosâ€¦');

          setProgress(100, 'Starting downloadâ€¦');
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = '';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);

          log('âœ… Download started. Choose save location in your browser.');
        } catch (err) {
          alert(`Error: ${err.message}`);
        } finally {
          hideProgress();
        }
      }

      async function setDestinationPath(path) {
        try {
          const response = await fetch('/api/select-destination', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: path })
          });

          const data = await response.json();

          if (data.success) {
            destinationPath = data.path;
            log(`âœ… Destination set: ${data.name}`);

            if (selectedFilesArray && selectedFilesArray.length > 0) {
              await transferFiles(selectedFilesArray);
            } else {
              alert('No files to transfer!');
            }
          } else {
            alert(`Error: ${data.error}`);
          }
        } catch (err) {
          alert(`Error: ${err.message}`);
        }
      }

      async function transferFiles(filesToTransfer) {
        if (!filesToTransfer || filesToTransfer.length === 0) {
          alert("No photos selected!");
          return;
        }

        if (!destinationPath) {
          alert("Destination folder not selected!");
          return;
        }

        log(`ðŸš€ Starting transfer of ${filesToTransfer.length} files...`);
        showProgress();
        setProgress(0, 'Uploading photosâ€¦');

        try {
          const formData = new FormData();
          for (let i = 0; i < filesToTransfer.length; i++) {
            const file = filesToTransfer[i];
            formData.append('files', file);
            log(`ðŸ“¤ Queuing: ${file.name}...`);
          }

          const responseJson = await uploadWithProgress('/api/transfer-files', formData, 'Uploading photosâ€¦', true);

          if (responseJson.success) {
            log(`âœ… Transferred: ${responseJson.transferred} files`);
            if (responseJson.failed > 0) {
              log(`âŒ Failed: ${responseJson.failed} files`);
              if (responseJson.results && responseJson.results.failed && responseJson.results.failed.length > 0) {
                responseJson.results.failed.forEach(f => {
                  log(`  - ${f.filename}: ${f.error}`);
                });
              }
            }
            log(`ðŸŽ‰ Done!`);
            alert("Transfer Complete!");
          } else {
            log(`âŒ Error: ${responseJson.error}`);
            alert(`Transfer failed: ${responseJson.error}`);
          }
        } catch (err) {
          log(`âŒ Error: ${err.message}`);
          alert(`Transfer failed: ${err.message}`);
        } finally {
          hideProgress();
        }
      }

      function uploadWithProgress(url, formData, label, expectJson = false) {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open('POST', url, true);

          xhr.upload.onprogress = (event) => {
            if (event.lengthComputable) {
              const percent = Math.round((event.loaded / event.total) * 100);
              setProgress(percent, `${label} ${percent}%`);
            } else {
              setProgress(50, `${label} â€¦`);
            }
          };

          xhr.onload = () => {
            try {
              if (xhr.status >= 200 && xhr.status < 300) {
                if (expectJson) {
                  resolve(JSON.parse(xhr.responseText));
                } else {
                  resolve(xhr.response);
                }
              } else {
                reject(new Error(xhr.responseText || `Request failed: ${xhr.status}`));
              }
            } catch (e) {
              reject(e);
            }
          };

          xhr.onerror = () => reject(new Error('Network error'));

          if (!expectJson) {
            xhr.responseType = 'blob';
          }

          xhr.send(formData);
        });
      }

      function log(msg) {
        const div = document.getElementById("log");
        div.innerHTML += `<div>${msg}</div>`;
        div.scrollTop = div.scrollHeight;
      }
    </script>
  </body>
</html>
